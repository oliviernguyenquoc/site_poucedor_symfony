// Sir Trevor, v0.1.2

(function(a,b){function g(a){var c={};return b.each(a,function(d,e){c[b.isArray(a)?d:e]=!0}),c}function h(a){a.preventDefault(),a.stopPropagation()}function i(a){return a.which==17||a.which==224}function j(a,b,c){var d=a.offset().left-b,e=a.offset().top-b,f=d+a.width()+2*b,g=e+a.height()+2*b,h=c.pageX,i=c.pageY;return h>d&&h<f&&i>e&&i<g}function n(a){return a.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}var c=this,d;d=c.SirTrevor={},d.DEBUG=!0,d.SKIP_VALIDATION=!1,d.DEFAULTS={baseCSSClass:"sir-trevor",defaultType:"Text",spinner:{className:"spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},marker:{baseCSSClass:"marker",buttonClass:"button",addText:"Click to add:",dropText:"Drop to place content"},formatBar:{baseCSSClass:"formatting-control"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/"},d.Blocks={},d.Formatters={},d.instances=[];var e=!1,f={bound:[],_bindFunctions:function(){var a=[];a.push(this),a.join(this.bound),b.bindAll.apply(this,a)}};(function(a){function b(a){h(a)}function c(a){a.originalEvent.dataTransfer.dropEffect="copy",h(a)}function d(a){h(a)}a.fn.dropArea=function(){return this.bind("dragenter",b).bind("dragover",c).bind("dragleave",d),this},a.fn.noDropArea=function(){return this.unbind("dragenter").unbind("dragover").unbind("dragleave"),this}})(jQuery);var k=function(a,b){return m(this,a,b)},l=function(){},m=function(a,c,d){var e;return c&&c.hasOwnProperty("constructor")?e=c.constructor:e=function(){a.apply(this,arguments)},b.extend(e,a),l.prototype=a.prototype,e.prototype=new l,c&&b.extend(e.prototype,c),d&&b.extend(e,d),e.prototype.constructor=e,e.__super__=a.prototype,e};d.log=function(a){!b.isUndefined(console)&&d.DEBUG&&console.log(a)};var o=a(d);d.subscribe=d.on=function(){o.on.apply(o,arguments)},d.unsubscribe=d.off=function(){o.off.apply(o,arguments)},d.publish=d.trigger=function(){o.trigger.apply(o,arguments)},d.subscribeAll=function(a){b.each(a,function(a){o.on.apply(o,arguments)})},function(a,b,c){function d(a,c){var d=b.createElement(a||"div"),e;for(e in c)d[e]=c[e];return d}function e(a){for(var b=1,c=arguments.length;b<c;b++)a.appendChild(arguments[b]);return a}function f(a,b,c,d){var e=["opacity",b,~~(a*100),c,d].join("-"),f=.01+c/d*100,g=Math.max(1-(1-a)/b*(100-f),a),h=m.substring(0,m.indexOf("Animation")).toLowerCase(),i=h&&"-"+h+"-"||"";return l[e]||(n.insertRule("@"+i+"keyframes "+e+"{"+"0%{opacity:"+g+"}"+f+"%{opacity:"+a+"}"+(f+.01)+"%{opacity:1}"+(f+b)%100+"%{opacity:"+a+"}"+"100%{opacity:"+g+"}"+"}",0),l[e]=1),e}function g(a,b){var d=a.style,e,f;if(d[b]!==c)return b;b=b.charAt(0).toUpperCase()+b.slice(1);for(f=0;f<k.length;f++){e=k[f]+b;if(d[e]!==c)return e}}function h(a,b){for(var c in b)a.style[g(a,c)||c]=b[c];return a}function i(a){for(var b=1;b<arguments.length;b++){var d=arguments[b];for(var e in d)a[e]===c&&(a[e]=d[e])}return a}function j(a){var b={x:a.offsetLeft,y:a.offsetTop};while(a=a.offsetParent)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}var k=["webkit","Moz","ms","O"],l={},m,n=function(){var a=d("style");return e(b.getElementsByTagName("head")[0],a),a.sheet||a.styleSheet}(),o={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},p=function q(a){if(!this.spin)return new q(a);this.opts=i(a||{},q.defaults,o)};p.defaults={},i(p.prototype,{spin:function(a){this.stop();var b=this,c=b.opts,e=b.el=h(d(0,{className:c.className}),{position:"relative",zIndex:c.zIndex}),f=c.radius+c.length+c.width,g,i;a&&(a.insertBefore(e,a.firstChild||null),i=j(a),g=j(e),h(e,{left:(c.left=="auto"?i.x-g.x+(a.offsetWidth>>1):c.left+f)+"px",top:(c.top=="auto"?i.y-g.y+(a.offsetHeight>>1):c.top+f)+"px"})),e.setAttribute("aria-role","progressbar"),b.lines(e,b.opts);if(!m){var k=0,l=c.fps,n=l/c.speed,o=(1-c.opacity)/(n*c.trail/100),p=n/c.lines;!function q(){k++;for(var a=c.lines;a;a--){var d=Math.max(1-(k+a*p)%n*o,c.opacity);b.opacity(e,c.lines-a,d,c)}b.timeout=b.el&&setTimeout(q,~~(1e3/l))}()}return b},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c),this},lines:function(a,b){function c(a,c){return h(d(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:c,transformOrigin:"left",transform:"rotate("+~~(360/b.lines*g+b.rotate)+"deg) translate("+b.radius+"px"+",0)",borderRadius:(b.width>>1)+"px"})}var g=0,i;for(;g<b.lines;g++)i=h(d(),{position:"absolute",top:1+~(b.width/2)+"px",transform:b.hwaccel?"translate3d(0,0,0)":"",opacity:b.opacity,animation:m&&f(b.opacity,b.trail,g,b.lines)+" "+1/b.speed+"s linear infinite"}),b.shadow&&e(i,h(c("#000","0 0 4px #000"),{top:"2px"})),e(a,e(i,c(b.color,"0 0 1px rgba(0,0,0,.1)")));return a},opacity:function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)}}),!function(){function a(a,b){return d("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',b)}var b=h(d("group"),{behavior:"url(#default#VML)"});!g(b,"transform")&&b.adj?(n.addRule(".spin-vml","behavior:url(#default#VML)"),p.prototype.lines=function(b,c){function d(){return h(a("group",{coordsize:i+" "+i,coordorigin:-g+" "+ -g}),{width:i,height:i})}function f(b,f,i){e(k,e(h(d(),{rotation:360/c.lines*b+"deg",left:~~f}),e(h(a("roundrect",{arcsize:1}),{width:g,height:c.width,left:c.radius,top:-c.width>>1,filter:i}),a("fill",{color:c.color,opacity:c.opacity}),a("stroke",{opacity:0}))))}var g=c.length+c.width,i=2*g,j=-(c.width+c.length)*2+"px",k=h(d(),{position:"absolute",top:j,left:j}),l;if(c.shadow)for(l=1;l<=c.lines;l++)f(l,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(l=1;l<=c.lines;l++)f(l);return e(b,k)},p.prototype.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&b+d<e.childNodes.length&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}):m=g(b,"animation")}(),a.Spinner=p}(window,document),function(a){a.fn.limit_chars=function(){if(this.length===0)return;this.attr("maxlength")&&(this.attr("data-maxlength",this.attr("maxlength")),this.removeAttr("maxlength")),this.parents(".extended_input").length===0&&(count=this.chars()<this.attr("data-maxlength")?this.chars():"<em>"+this.chars()+"</em>",this.wrap(a("<div>",{"class":"extended_input"})).after(a("<span>",{"class":"count",html:count+" of "+this.attr("data-maxlength")})),this.bind("keydown keyup paste",function(b){count=a(this).chars()<a(this).attr("data-maxlength")?a(this).chars():"<em>"+a(this).chars()+"</em>",a(this).parent().find(".count").html(count+" of "+a(this).attr("data-maxlength"))}))},a.fn.chars=function(){return count=this.attr("contenteditable")!==undefined?this.text().length:count=this.val().length,count},a.fn.too_long=function(){return this.chars()>this.attr("data-maxlength")}}(jQuery),d.blockStore=function(a,b,c){var d;c=c||{};switch(a){case"create":var e=c.data||{};b.dataStore={type:b.type.toLowerCase(),data:e};break;case"save":c.data&&(b.dataStore.data=c.data,d=b.dataStore);break;case"read":d=b.dataStore}if(d)return d},d.editorStore=function(a,c,d){var e;d=d||{};switch(a){case"create":var f=c.$el.val();c.dataStore={data:[]};if(f.length>0)try{var g=JSON.parse(f);b.isUndefined(g.data)||(c.dataStore=g)}catch(h){console.log("Sorry there has been a problem with parsing the JSON"),console.log(h)}break;case"reset":c.dataStore={data:[]};break;case"add":d.data&&(c.dataStore.data.push(d.data),e=c.dataStore);break;case"save":c.$el.val(c.dataStore.data.length>0?JSON.stringify(c.dataStore):"");break;case"read":e=c.dataStore}if(e)return e};var p=function(){this.intialize()};b.extend(p.prototype,{intialize:function(){this.submitBtn=a("input[type='submit']");var c=[];b.each(this.submitBtn,function(b){c.push(a(b).attr("value"))}),this.submitBtnTitles=c,this.canSubmit=!0,this.globalUploadCount=0,this._bindEvents()},setSubmitButton:function(a,b){this.submitBtn.attr("value",b)},resetSubmitButton:function(){b.each(this.submitBtn,b.bind(function(b,c){a(b).attr("value",this.submitBtnTitles[c])},this))},onUploadStart:function(a){this.globalUploadCount++,d.log("onUploadStart called "+this.globalUploadCount),this.globalUploadCount===1&&this._disableSubmitButton()},onUploadStop:function(a){this.globalUploadCount=this.globalUploadCount<=0?0:this.globalUploadCount-1,d.log("onUploadStop called "+this.globalUploadCount),this.globalUploadCount===0&&this._enableSubmitButton()},onError:function(a){d.log("onError called"),this.canSubmit=!1},_disableSubmitButton:function(a){this.setSubmitButton(null,a||"Please wait..."),this.submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton(),this.submitBtn.removeAttr("disabled").removeClass("disabled")},_bindEvents:function(){d.subscribe("disableSubmitButton",b.bind(this._disableSubmitButton,this)),d.subscribe("enableSubmitButton",b.bind(this._enableSubmitButton,this)),d.subscribe("setSubmitButton",b.bind(this.setSubmitButton,this)),d.subscribe("resetSubmitButton",b.bind(this.resetSubmitButton,this)),d.subscribe("onError",b.bind(this.onError,this)),d.subscribe("onUploadStart",b.bind(this.onUploadStart,this)),d.subscribe("onUploadStop",b.bind(this.onUploadStop,this))}}),d.submittable=function(){new p},d.fileUploader=function(c,e,f,g){d.publish("onUploadStart");var h=[c.instance.ID,(new Date).getTime(),"raw"].join("-"),i=new FormData;i.append("attachment[name]",e.name),i.append("attachment[file]",e),i.append("attachment[uid]",h);var j=function(a){!b.isUndefined(f)&&b.isFunction(f)&&(d.log("Upload callback called"),d.publish("onUploadStop"),b.bind(f,c)(a))},k=function(a,e,f){!b.isUndefined(g)&&b.isFunction(g)&&(d.log("Upload callback error called"),d.publish("onUploadError"),b.bind(g,c)(e))};a.ajax({url:c.instance.options.uploadUrl,data:i,cache:!1,contentType:!1,processData:!1,type:"POST",success:j,error:k})};var q=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;b.mixin({isURI:function(a){return q.test(a)},capitalize:function(a){return a.charAt(0).toUpperCase()+a.substring(1).toLowerCase()}});var r=d.Block=function(a,c){this.instance=a,this.type=this._getBlockType(),this.store("create",this,{data:c}),this.uploadsCount=0,this.blockID=b.uniqueId(this.className+"-"),this._setBaseElements(),this._bindFunctions(),this.render(),this.initialize.apply(this,arguments)},s=["className","toolbarEnabled","dropEnabled","title","limit","editorHTML","dropzoneHTML","validate","loadData","toData","onDrop","onContentPasted","onBlockRender","beforeBlockRender","toMarkdown","toHTML"];b.extend(r.prototype,f,{bound:["_handleDrop","_handleContentPaste","onBlockFocus","onBlockBlur","onDrop","onDragStart","onDragEnd"],$:function(a){return this.$el.find(a)},$$:function(a){return this.$editor.find(a)},className:"",title:"",limit:0,editorHTML:"<div></div>",dropzoneHTML:'<div class="dropzone"><p>Drop content here</p></div>',toolbarEnabled:!0,dropEnabled:!1,initialize:function(){},loadData:function(a){},onBlockRender:function(){},beforeBlockRender:function(){},toMarkdown:function(a){return a},toHTML:function(a){return a},store:function(){return d.blockStore.apply(this,arguments)},render:function(){this.beforeBlockRender(),this.instance.formatBar.hide(),this.instance.marker.hide(),this.instance.marker.$el.before(this.$el),this.dropEnabled&&this._initDragDrop();var c=this.getData();!b.isUndefined(c)&&!b.isEmpty(c)&&this._loadData(),this.save(),this.$el.append(a("<span>",{"class":"handle",draggable:!0})),this.$el.append(a("<span>",{"class":"delete block-delete"})),this.$el.bind("drop",h).bind("mouseover",h).bind("mouseout",h).bind("dragleave",h).bind("mouseover",function(b){a(this).siblings().removeClass("active"),a(this).addClass("active")}).bind("mouseout",function(b){a(this).removeClass("active")}).bind("dragover",function(a){a.preventDefault()}),this._initPaste(),this.$(".delete.block-delete").bind("click",this.onDeleteClick),this.$$(".text-block").length>0&&(document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBrOnReturn",!1,!0),this.$$(".text-block").focus(this.onBlockFocus).blur(this.onBlockBlur),this.$$(".text-block").bind("paste",this._handleContentPaste),this._initFormatting());if(b.isEmpty(c.data)){var d=this.$$('[contenteditable="true"], input');d.length>0&&!this.dropEnabled&&d[0].focus()}this._initReordering(),this._initTextLimits(),this.$el.addClass("sir-trevor-item-ready"),this.onBlockRender()},remove:function(){this.$el.remove()},save:function(){return this.toData(),this.store("read",this)},getData:function(){return this.store("read",this).data},setData:function(a){d.log("Setting data for block "+this.blockID),this.store("save",this,{data:a})},loading:function(){b.isUndefined(this.spinner)||this.ready(),this.spinner=new Spinner(this.instance.options.spinner),this.spinner.spin(this.$el[0]),this.$el.addClass("loading")},ready:function(){this.$el.removeClass("loading"),b.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},validate:function(){this._beforeValidate();var c=this.$$(".required, [data-maxlength]"),d=0;return b.each(c,b.bind(function(b){b=a(b);var c=b.attr("contenteditable")?b.text():b.val(),e=b.attr("data-maxlength")&&b.too_long(),f=b.hasClass("required");if(f&&c.length===0||e)b.addClass("error").before(a("<div>",{"class":"error-marker",html:"!"})),d++},this)),d===0},toData:function(){d.log("toData for "+this.blockID);var c=this.$el,e={};if(this.$$(".text-block").length>0){var f=this.$$(".text-block").html();f.length>0&&(e.text=this.instance._toMarkdown(f,this.type))}var g=!b.isUndefined(e.text)||this.$$(".text-block").length===0;this.$$('input[type="text"]').not(".paste-block").length>0&&this.$$('input[type="text"]').each(function(b,c){c=a(c),c.val().length>0&&g&&(e[c.attr("name")]=c.val())}),this.$$("select").each(function(b,c){c=a(c),c.val().length>0&&g&&(e[c.attr("name")]=c.val())}),this.$$('input[type="file"]').each(function(b,c){c=a(c),e.file=c.data("json")}),b.isEmpty(e)||this.setData(e)},onDrop:function(a){},onDragStart:function(b){var c=a(b.target);b.originalEvent.dataTransfer.setDragImage(c.parent()[0],13,25),b.originalEvent.dataTransfer.setData("Text",c.parent().attr("id")),c.parent().addClass("dragging"),this.instance.formatBar.hide()},onDragEnd:function(b){var c=a(b.target);c.parent().removeClass("dragging"),this.instance.marker.hide()},onBlockFocus:function(a){b.delay(b.bind(function(){this.instance.formatBar.clicked=!1,this.instance.formatBar.show(this.$el)},this),250)},onBlockBlur:function(a){b.delay(b.bind(function(){this.instance.formatBar.clicked||this.instance.formatBar.hide()},this),250)},onDeleteClick:function(a){confirm("Are you sure you wish to delete this content?")&&(this.instance.removeBlock(this),h(a))},onContentPasted:function(a){var b=this.$$(".text-block");b.length>0&&b.html(this.instance._toHTML(this.instance._toMarkdown(b.html(),this.type)))},uploader:function(a,b){d.fileUploader(this,a,b)},_loadData:function(){d.log("loadData for "+this.blockID),this.loading(),this.dropEnabled&&(this.$dropzone.hide(),this.$editor.show()),d.publish("editor/block/loadData"),this.loadData(this.getData()),this.ready()},_beforeValidate:function(){this.errors=[],this.$(".error").removeClass("error"),this.$(".error-marker").remove()},_handleContentPaste:function(a){var c=function(a){this.onContentPasted(a)};b.delay(b.bind(c,this,a),100)},_handleDrop:function(c){c.preventDefault(),c=c.originalEvent,d.publish("editor/block/handleDrop");var e=a(c.target),f=c.dataTransfer.types,g,h=[];this.instance.formatBar.hide(),this.instance.marker.hide(),this.$dropzone.removeClass("dragOver"),b.isUndefined(f)||(b.include(f,"Files")||b.include(f,"text/plain")||b.include(f,"text/uri-list"))&&this.onDrop(c.dataTransfer)},_setBaseElements:function(){var c=b.isFunction(this.editorHTML)?this.editorHTML():this.editorHTML,d=a("<div>",{"class":"block-editor "+this.className+"-block",html:c});this.$el=a("<div>",{"class":this.instance.options.baseCSSClass+"-block",id:this.blockID,"data-type":this.type,"data-instance":this.instance.ID,html:d}),this.el=this.$el[0],this.$editor=d},_getBlockType:function(){var a="";for(var b in d.Blocks)d.Blocks[b].prototype==Object.getPrototypeOf(this)&&(a=b);return a},_initDragDrop:function(){d.log("Adding drag and drop capabilities for block "+this.blockID),this.$dropzone=a("<div>",{html:this.dropzoneHTML,"class":"dropzone "+this.className+"-block"}),this.$el.append(this.$dropzone),this.$editor.hide(),this.$dropzone.dropArea(),this.$dropzone.bind("drop",this._handleDrop)},_initReordering:function(){this.$(".handle").bind("dragstart",this.onDragStart).bind("dragend",this.onDragEnd).bind("drag",this.instance.marker.show)},_initFormatting:function(){var a;for(var c in this.instance.formatters)this.instance.formatters.hasOwnProperty(c)&&(a=d.Formatters[c],b.isUndefined(a.keyCode)||a._bindToBlock(this.$editor))},_initPaste:function(){this.$(".paste-block").bind("click",function(){a(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)},_initTextLimits:function(){this.$$("input[maxlength!=-1][maxlength!=524288][maxlength!=2147483647]").limit_chars()}}),r.extend=k;var t=d.Formatter=function(a){this.formatId=b.uniqueId("format-"),this._configure(a||{}),this.className=d.DEFAULTS.baseCSSClass+"-format-"+this.options.className,this.initialize.apply(this,arguments)},u=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];b.extend(t.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(a){return a},toHTML:function(a){return a},initialize:function(){},_configure:function(a){this.options&&(a=b.extend({},this.options,a));for(var c=0,d=u.length;c<d;c++){var e=u[c];a[e]&&(this[e]=a[e])}this.options=a},_bindToBlock:function(a){var b=this,c=!1;a.on("keyup",".text-block",function(a){if(a.which==17||a.which==224)c=!1}).on("keydown",".text-block",{formatter:b},function(a){if(a.which==17||a.which==224)c=!0;a.which==a.data.formatter.keyCode&&c===!0&&(document.execCommand(a.data.formatter.cmd,!1,!0),a.preventDefault())})}}),t.extend=k,d.Blocks.Quote=d.Block.extend({title:"Quote",className:"block-quote",limit:0,editorHTML:function(){return b.template('<blockquote class="required text-block <%= className %>" contenteditable="true"></blockquote><div class="input text"><label>Credit</label><input maxlength="140" name="cite" class="input-string required" type="text" /></div>',this)},loadData:function(a){this.$$(".text-block").html(this.instance._toHTML(a.text,this.type)),this.$$("input").val(a.cite)},toMarkdown:function(a){return a.replace(/^(.+)$/mg,"> $1")}});var v='<p>Drop images here</p><div class="input submit"><input type="file" multiple="multiple" /></div><button>...or choose file(s)</button>';d.Blocks.Gallery=d.Block.extend({title:"Gallery",className:"gallery",dropEnabled:!0,editorHTML:'<div class="gallery-items"><p>Gallery Contents:</p><ul></ul></div>',dropzoneHTML:v,loadData:function(a){b.isArray(a)&&(b.each(a,b.bind(function(a){this.renderGalleryThumb(a)},this)),this.$dropzone.show())},renderGalleryThumb:function(c){if(b.isUndefined(c.data.file))return!1;var d=a("<img>",{src:c.data.file.thumb.url}),e=a("<li>",{id:b.uniqueId("gallery-item"),"class":"gallery-item",html:d});e.append(a("<span>",{"class":"delete",click:b.bind(function(b){h(b),confirm("Are you sure you wish to delete this image?")&&(a(b.target).parent().remove(),this.reindexData())},this)})),e.data("block",c),this.$$("ul").append(e),e.dropArea().bind("dragstart",b.bind(function(b){var c=a(b.target);b.originalEvent.dataTransfer.setData("Text",c.parent().attr("id")),c.parent().addClass("dragging")},this)).bind("drag",b.bind(function(a){},this)).bind("dragend",b.bind(function(b){var c=a(b.target);c.parent().removeClass("dragging")},this)).bind("dragover",b.bind(function(b){var c=a(b.target);c.parents("li").addClass("dragover")},this)).bind("dragleave",b.bind(function(b){var c=a(b.target);c.parents("li").removeClass("dragover")},this)).bind("drop",b.bind(function(b){var c=a(b.target),d=c.parent();c=c.hasClass("gallery-item")?c:d,this.$$("ul li.dragover").removeClass("dragover");var e=a("#"+b.originalEvent.dataTransfer.getData("text/plain"));if(e.attr("id")===c.attr("id"))return!1;e.length>0&&e.hasClass("gallery-item")&&c.before(e),this.reindexData()},this))},onBlockRender:function(){this.$dropzone.find("button").bind("click",h),this.$dropzone.find("input").on("change",b.bind(function(a){this.onDrop(a.currentTarget)},this))},reindexData:function(){var c=this.getData();c=[],b.each(this.$$("li.gallery-item"),function(b){b=a(b),c.push(b.data("block"))}),this.setData(c)},onDrop:function(a){if(a.files.length>0){var c=a.files.length,d,e=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;this.loading();while(c--)d=a.files[c],/image/.test(d.type)&&(this.uploadsCount+=1,this.$editor.show(),this.uploader(d,function(a){this.uploadsCount-=1;var c=this.getData();a={type:"image",data:a},b.isArray(c)||(c=[]),c.push(a),this.setData(c),this.renderGalleryThumb(a),this.uploadsCount===0&&this.ready()}))}}});var v='<p>Drop image here</p><div class="input submit"><input type="file" /></div><button>...or choose a file</button>';d.Blocks.Image=d.Block.extend({title:"Image",className:"image",dropEnabled:!0,dropzoneHTML:v,loadData:function(b){this.$editor.html(a("<img>",{src:b.file.url}))},onBlockRender:function(){this.$dropzone.find("button").bind("click",h),this.$dropzone.find("input").on("change",b.bind(function(a){this.onDrop(a.currentTarget)},this))},onDrop:function(b){var c=b.files[0],e=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;/image/.test(c.type)&&(this.loading(),this.$dropzone.hide(),this.$editor.html(a("<img>",{src:e.createObjectURL(c)})),this.$editor.show(),d.publish("setSubmitButton",["Please wait..."]),this.uploader(c,function(a){this.setData(a),this.ready()},function(a){alert("Error!")}))}});var w=d.Blocks.Text=d.Block.extend({title:"Text",className:"text",limit:0,editorHTML:'<div class="required text-block" contenteditable="true"></div>',loadData:function(a){this.$$(".text-block").html(this.instance._toHTML(a.text,this.type))}}),x='<p>Drop tweet link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',y='<div class="tweet media"><div class="img"><img src="<%= user.profile_image_url %>" class="tweet-avatar"></div><div class="bd tweet-body"><p><a href="http://twitter.com/#!/<%= user.screen_name %>">@<%= user.screen_name %></a>: <%= text %></p><time><%= created_at %></time></div></div>';d.Blocks.Tweet=d.Block.extend({title:"Tweet",className:"tweet",dropEnabled:!0,dropzoneHTML:x,loadData:function(a){this.$editor.html(b.template(y,a))},onContentPasted:function(b){var c=a(b.target),d=c.val();this.handleTwitterDropPaste(d)},handleTwitterDropPaste:function(c){if(b.isURI(c)&&c.indexOf("twitter")!=-1&&c.indexOf("status")!=-1){var d=c.match(/[^\/]+$/);if(!b.isEmpty(d)){this.loading(),d=d[0];var e=function(a){var b={user:{profile_image_url:a.user.profile_image_url,profile_image_url_https:a.user.profile_image_url_https,screen_name:a.user.screen_name,name:a.user.name},text:a.text,created_at:a.created_at,status_url:c};this.setData(b),this._loadData(),this.ready()},f=function(){this.ready()};a.ajax({url:"http://api.twitter.com/1/statuses/show/"+d+".json",dataType:"JSONP",success:b.bind(e,this),error:b.bind(f,this)})}}},onDrop:function(a){var b=a.getData("text/plain");this.handleTwitterDropPaste(b)}});var z='<div class="text-block <%= className %>" contenteditable="true"></div>';d.Blocks.Ul=d.Block.extend({title:"List",className:"list",editorHTML:function(){return b.template(z,this)},onBlockRender:function(){this.$$(".text-block").bind("click",function(){a(this).html().length===0&&document.execCommand("insertUnorderedList",!1,!1)}),b.isEmpty(this.data)&&this.$$(".text-block").focus().click()},loadData:function(a){this.$$(".text-block").html("<ul>"+this.instance._toHTML(a.text,this.type)+"</ul>")},toMarkdown:function(a){return a.replace(/<\/li>/mg,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/mg," - $1")},toHTML:function(a){return a.replace(/^ - (.+)$/mg,"<li>$1</li>")}});var A='<p>Drop video link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',B=/http[s]?:\/\/(?:www.)?(?:(vimeo).com\/(.*))|(?:(youtu(?:be)?).(?:be|com)\/(?:watch\?v=)?([^&]*)(?:&(?:.))?)/;d.Blocks.Video=d.Block.extend({title:"Video",className:"video",dropEnabled:!0,dropzoneHTML:A,loadData:function(a){a.source=="youtube"||a.source=="youtu"?this.$editor.html('<iframe src="'+window.location.protocol+"//www.youtube.com/embed/"+a.remote_id+'" width="580" height="320" frameborder="0" allowfullscreen></iframe>'):a.source=="vimeo"&&this.$editor.html('<iframe src="'+window.location.protocol+"//player.vimeo.com/video/"+a.remote_id+'?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>')},onContentPasted:function(b){var c=a(b.target),d=c.val();this.handleDropPaste(d)},handleDropPaste:function(a){if(b.isURI(a))if(a.indexOf("youtu")!=-1||a.indexOf("vimeo")!=-1){var c={},d=a.match(B);d[3]!==undefined?(c.source=d[3],c.remote_id=d[4]):d[1]!==undefined&&(c.source=d[1],c.remote_id=d[2]),c.source=="youtu"&&(c.source="youtube"),this.setData(c),this._loadData()}},onDrop:function(a){var b=a.getData("text/plain");this.handleDropPaste(b)}});var C=d.Formatter.extend({title:"B",className:"bold",cmd:"bold",keyCode:66}),D=d.Formatter.extend({title:"I",className:"italic",cmd:"italic",keyCode:73}),E=d.Formatter.extend({title:"U",className:"underline",cmd:"underline"}),F=d.Formatter.extend({title:"Link",className:"link",cmd:"CreateLink",onClick:function(){var a=prompt("Enter a link"),b=/(ftp|http|https):\/\/./;a&&a.length>0&&(b.test(a)||(a="http://"+a),document.execCommand(this.cmd,!1,a))}}),G=d.Formatter.extend({title:"Unlink",className:"link",cmd:"unlink"}),H=d.Formatter.extend({title:"H1",className:"heading h1",cmd:"formatBlock",param:"H1",toMarkdown:function(a){return a.replace(/<h1>([^*|_]+)<\/h1>/mg,"#$1#\n")},toHTML:function(a){return a.replace(/(?:#)([^*|_]+)(?:#)/mg,"<h1>$1</h1>")}}),I=d.Formatter.extend({title:"H2",className:"heading h2",cmd:"formatBlock",param:"H2",toMarkdown:function(a){return a.replace(/<h2>([^*|_]+)<\/h2>/mg,"##$1##\n")},toHTML:function(a){return a.replace(/(?:##)([^*|_]+)(?:##)/mg,"<h2>$1</h2>")}});d.Formatters.Bold=new C,d.Formatters.Italic=new D,d.Formatters.Link=new F,d.Formatters.Unlink=new G;var J=d.Marker=function(a,c){this.instance=c,this.options=b.extend({},d.DEFAULTS.marker,a||{}),this._bindFunctions()};b.extend(J.prototype,f,{bound:["onButtonClick","show","hide","onDrop"],render:function(){var b=a("<span>",{"class":this.instance.options.baseCSSClass+"-"+this.options.baseCSSClass,html:"<p>"+this.options.addText+'</p><div class="buttons"></div>'});this.instance.$wrapper.append(b),this.$el=b,this.$btns=this.$el.find(".buttons"),this.$p=this.$el.find("p");var c,e;for(c in this.instance.blockTypes)d.Blocks.hasOwnProperty(c)&&(e=d.Blocks[c],e.prototype.toolbarEnabled&&this.$btns.append(a("<a>",{href:"#","class":this.options.buttonClass+" new-"+e.prototype.className,"data-type":c,text:e.prototype.title,click:this.onButtonClick})));this.$btns.children().length===0&&this.$el.addClass("hidden"),this.instance.$outer.bind("mouseover",this.show),this.instance.$outer.bind("mouseout",this.hide),this.instance.$outer.bind("dragover",this.show),this.$el.bind("dragover",h),this.instance.$outer.dropArea(),this.instance.$outer.bind("dragleave",this.hide),this.instance.$outer.bind("drop",this.onDrop),this.$el.addClass("sir-trevor-item-ready")},show:function(c){c.type=="drag"||c.type=="dragover"?(this.$p.text(this.options.dropText),this.$btns.hide()):(this.$p.text(this.options.addText),this.$btns.show());var d=c?c.originalEvent.pageY-this.instance.$wrapper.offset().top:0;if(this.instance.blocks.length>0){var e=!1,f=this.instance.$wrapper,g="."+this.instance.options.baseCSSClass+"-block",h=function(b,c){b=a(b);var f=b.position().top-40,g=b.position().top+b.outerHeight(!0)-40;f<=d&&d<g&&(e=b)};b.each(f.find(g),b.bind(h,this)),e?this.$el.insertBefore(e):d>0?this.$el.insertAfter(f.find(g).last()):this.$el.insertBefore(f.find(g).first())}this.$el.addClass("sir-trevor-item-ready")},hide:function(a){this.$el.removeClass("sir-trevor-item-ready")},onDrop:function(c){c.preventDefault();var d=this.$el,e=c.originalEvent.dataTransfer.getData("text/plain"),f=a("#"+e);!b.isUndefined(e)&&!b.isEmpty(f)&&f.attr("data-instance")==this.instance.ID&&d.after(f)},remove:function(){this.$el.remove()},onButtonClick:function(b){h(b);var c=a(b.target);if(c.hasClass("inactive"))return alert("You cannot create any more blocks of this type"),!1;this.instance.createBlock(c.attr("data-type"),{})},move:function(a){this.$el.css({top:a}),this.$el.show(),this.$el.addClass("sir-trevor-item-ready")}});var K=d.FormatBar=function(a,c){this.instance=c,this.options=b.extend({},d.DEFAULTS.formatBar,a||{}),this.className=this.instance.options.baseCSSClass+"-"+this.options.baseCSSClass,this.clicked=!1,this._bindFunctions()};b.extend(K.prototype,f,{bound:["onFormatButtonClick"],render:function(){var c=a("<div>",{"class":this.className});this.instance.$wrapper.prepend(c),this.$el=c;var e=this.instance.formatters,f,g;for(f in e)d.Formatters.hasOwnProperty(f)&&(g=d.Formatters[f],a("<button>",{"class":"format-button "+g.className,text:g.title,"data-type":f,"data-cmd":g.cmd,click:this.onFormatButtonClick}).appendTo(this.$el));this.$el.find("button").length===0&&this.$el.addClass("hidden"),this.hide(),this.$el.bind("mouseout",b.bind(function(a){h(a),this.clicked=!1},this)),this.$el.bind("mouseover",h)},show:function(a){this.$el.css({top:a.position().top}),this.$el.addClass("sir-trevor-item-ready"),this.$el.show()},hide:function(){this.clicked=!1,this.$el.removeClass("sir-trevor-item-ready"),this.$el.hide()},remove:function(){this.$el.remove()},onFormatButtonClick:function(c){h(c),this.clicked=!0;var e=a(c.target),f=d.Formatters[e.attr("data-type")];!b.isUndefined(f.onClick)&&b.isFunction(f.onClick)?f.onClick():document.execCommand(e.attr("data-cmd"),!1,f.param),this.$el.addClass("sir-trevor-item-ready")}});var L=d.Editor=function(a){d.log("Init SirTrevor.Editor"),this.blockTypes={},this.formatters={},this.blockCounts={},this.blocks=[],this.errors=[],this.options=b.extend({},d.DEFAULTS,a||{}),this.ID=b.uniqueId(this.options.baseCSSClass+"-"),this._ensureAndSetElements()&&(this.marker=new d.Marker(this.options.marker,this),this.formatBar=new d.FormatBar(this.options.formatBar,this),!b.isUndefined(this.options.onEditorRender)&&b.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender),this._setRequired(),this._setBlocksAndFormatters(),this._bindFunctions(),this.store("create",this),this.build(),d.instances.push(this),d.bindFormSubmit(this.$form))};b.extend(L.prototype,f,{bound:["onFormSubmit"],initialize:function(){},build:function(){this.$el.hide(),this.marker.render(),this.formatBar.render();var a=this.store("read",this);a.data.length===0?this.createBlock(this.options.defaultType):b.each(a.data,b.bind(function(a){console.log("Creating: ",a),this.createBlock(a.type,a.data)},this)),this.$wrapper.addClass("sir-trevor-ready"),b.isUndefined(this.onEditorRender)||this.onEditorRender()},store:function(){return d.editorStore.apply(this,arguments)},createBlock:function(a,c){a=b.capitalize(a);if(this._blockTypeAvailable(a)){var e=d.Blocks[a],f=b.isUndefined(this.blockCounts[a])?0:this.blockCounts[a],g=this.blocks.length,h=this._getBlockTypeLimit(a);if(h!==0&&f>h||this.options.blockLimit!==0&&g>=this.options.blockLimit)return d.log("Block Limit reached for type "+a),!1;var i=new e(this,c||{});b.isUndefined(this.blockCounts[a])&&(this.blockCounts[a]=0),this.blocks.push(i),f++,this.blockCounts[a]=f,this.options.blockLimit!==0&&this.blocks.length>=this.options.blockLimit&&this.marker.$el.addClass("hidden"),h!==0&&f>=h&&(d.log("Block Limit reached for type "+a+" setting state as inactive"),this.marker.$el.find('[data-type="'+a+'"]').addClass("inactive").attr("title","You have reached the limit for this type of block")),d.publish("editor/block/createBlock"),d.log("Block created of type "+a)}else d.log("Block type not available "+a)},removeBlock:function(a){a.remove(),this.blockCounts[a.type]=this.blockCounts[a.type]-1,this.blocks=b.reject(this.blocks,function(b){return b.blockID==a.blockID}),b.isUndefined(this.blocks)&&(this.blocks=[]),this.formatBar.hide(),d.publish("editor/block/removeBlock"),this._getBlockTypeLimit(a.type)>this.blockCounts[a.type]&&(d.log("Removing block limit for "+a.type),this.marker.$el.find('[data-type="'+a.type+'"]').removeClass("inactive").attr("title","Add a "+a.type+" block"))},performValidations:function(a,c){var e=0;!d.SKIP_VALIDATION&&c?a.validate()||(d.log("Block "+a.blockID+" failed validation"),++e):a._beforeValidate();var f=a.save();return b.isEmpty(f.data)||(d.log("Adding data for block "+a.blockID+" to block store"),this.store("add",this,{data:f})),e},onFormSubmit:function(c){c=c===!1?!1:!0,d.log("Handling form submission for Editor "+this.ID);var e,f,g,h=0;this.formatBar.hide(),this.removeErrors(),this.store("reset",this);var i=function(e,f){e=a(e);var g=b.find(this.blocks,function(a){return a.blockID==e.attr("id")});if(!b.isUndefined(g)||!b.isEmpty(g)||typeof g==d.Block)h+=this.performValidations(g,c)};return b.each(this.$wrapper.find("."+this.options.baseCSSClass+"-block"),b.bind(i,this)),this.required&&!d.SKIP_VALIDATION&&c&&b.each(this.required,b.bind(function(a){if(this._blockTypeAvailable(a))if(b.isUndefined(this.blockCounts[a])||this.blockCounts[a]===0)this.errors.push({text:"You must have a block of type "+a}),d.log("Failed validation on required block type "+a),h++;else{var c=b.filter(this.blocks,function(c){return c.type==a&&!b.isEmpty(c.getData())});c.length===0&&(this.errors.push({text:"A required block type "+a+" is empty"}),h++,d.log("A required block type "+a+" is empty"))}},this)),this.store("save",this),h>0&&this.renderErrors(),h},renderErrors:function(){if(this.errors.length>0){b.isUndefined(this.$errors)&&(this.$errors=a("<div>",{"class":this.options.baseCSSClass+"-errors",html:"<p>You have the following errors: </p><ul></ul>"}),this.$outer.prepend(this.$errors));var c=this.$errors.find("ul");b.each(this.errors,b.bind(function(b){c.append(a("<li>",{"class":"error-msg",html:b.text}))},this)),this.$errors.show()}},removeErrors:function(){this.errors.length>0&&(this.$errors.find("ul").html(""),this.$errors.hide(),this.errors=[])},_getBlockTypeLimit:function(a){return this._blockTypeAvailable(a)?b.isUndefined(this.options.blockTypeLimits[a])?d.Blocks[a].prototype.limit:this.options.blockTypeLimits[a]:0},_blockTypeAvailable:function(a){return!b.isUndefined(this.blockTypes[a])},_formatterAvailable:function(a){return!b.isUndefined(this.formatters[a])},_ensureAndSetElements:function(){return b.isUndefined(this.options.el)||b.isEmpty(this.options.el)?(d.log("You must provide an el"),!1):(this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form"),this.$el.wrap(a("<div>",{id:this.ID,"class":this.options.baseCSSClass,dropzone:"copy link move"})).wrap(a("<div>",{"class":this.options.baseCSSClass+"-blocks"})),this.$outer=this.$form.find("#"+this.ID),this.$wrapper=this.$outer.find("."+this.options.baseCSSClass+"-blocks"),!0)},_setBlocksAndFormatters:function(){this.blockTypes=g(b.isUndefined(this.options.blockTypes)?d.Blocks:this.options.blockTypes),this.formatters=g(b.isUndefined(this.options.formatters)?d.Formatters:this.options.formatters)},_setRequired:function(){this.required=b.isArray(this.options.required)&&!b.isEmpty(this.options.required)?this.options.required:!1},_toMarkdown:function(a,c){var e;e=a.replace(/\n/mg,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/g,"[$2]($1)").replace(/<\/?b>/g,"**").replace(/<\/?STRONG>/g,"**").replace(/<\/?i>/g,"_").replace(/<\/?EM>/g,"_");var f,g;for(f in this.formatters)d.Formatters.hasOwnProperty(f)&&(g=d.Formatters[f],!b.isUndefined(g.toMarkdown)&&b.isFunction(g.toMarkdown)&&(e=g.toMarkdown(e)));var h;return d.Blocks.hasOwnProperty(c)&&(h=d.Blocks[c],!b.isUndefined(h.prototype.toMarkdown)&&b.isFunction(h.prototype.toMarkdown)&&(e=h.prototype.toMarkdown(e))),e=e.replace(/([^<>]+)(<div>)/g,"$1\n\n$2").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n\n").replace(/<\/p>/g,"\n\n\n\n").replace(/<(.)?br(.)?>/g,"\n\n").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/<\/?[^>]+(>|$)/g,""),e},_toHTML:function(a,c){var e=a,f,g;for(f in this.formatters)d.Formatters.hasOwnProperty(f)&&(g=d.Formatters[f],!b.isUndefined(g.toHTML)&&b.isFunction(g.toHTML)&&(e=g.toHTML(e)));var h;return d.Blocks.hasOwnProperty(c)&&(h=d.Blocks[c],!b.isUndefined(h.prototype.toHTML)&&b.isFunction(h.prototype.toHTML)&&(e=h.prototype.toHTML(e))),e=e.replace(/^\> (.+)$/mg,"$1").replace(/\n\n/g,"<br>").replace(/\[([^\]]+)\]\(([^\)]+)\)/g,"<a href='$2'>$1</a>").replace(/(?:_)([^*|_]+)(?:_)/mg,"<i>$1</i>").replace(/(?:\*\*)([^*|_]+)(?:\*\*)/mg,"<b>$1</b>"),e}}),d.bindFormSubmit=function(a){e||(d.submittable(),a.bind("submit",this.onFormSubmit),e=!0)},d.onBeforeSubmit=function(a){var c=0;return b.each(d.instances,function(b,d){c+=b.onFormSubmit(a)}),d.log("Total errors: "+c),c},d.onFormSubmit=function(a){var b=d.onBeforeSubmit();b>0&&(d.publish("onError"),a.preventDefault())},d.runOnAllInstances=function(a){b.has(d.Editor.prototype,a)?([].unshift.call(arguments,d.instances),b.invoke.apply(b,arguments)):d.log("method doesn't exist")}})(jQuery,_);