<?php

namespace Pouce\TeamBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * TeamRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TeamRepository extends EntityRepository
{
	public function getLastTeam($idUser)    
	{
        $qb = $this -> createQueryBuilder('t')
                    -> join('t.users','u', 'WITH', 'u.id = :idUser')
                     -> setParameter('idUser', $idUser)
                    -> orderBy('u.created','DESC')
                    ->setMaxResults(1)
                   ;
        return $qb->getQuery();    
    }

    public function findOneTeamByEditionAndUsers($editionId, $userId)
    {
        $qb = $this -> createQueryBuilder('t')
                    -> join('t.edition','e', 'WITH', 'e.id = :editionId')
                     -> setParameter('editionId', $editionId)
                    -> join('t.users','u', 'WITH', 'u.id = :userId')
                     -> setParameter('userId', $userId)
                    -> orderBy('u.created','DESC')
                    ->setMaxResults(1)
                   ;
        return $qb->getQuery();            
    }

    /**
	*	Retourne l'équipe du user qui concourra à la prochaine édition
    */
    public function findNextRaceTeam($userId)
    {
        $now = new \DateTime();
        $qb = $this -> createQueryBuilder('t')
            -> join('t.users','u', 'WITH', 'u.id = :idUser')
             -> setParameter('idUser', $userId)
            -> join('t.edition','e','WITH','e.dateOfEvent > :today')
             ->setParameter('today', $now->format("Y-m-d"))
            -> orderBy('u.created','DESC')
            ->setMaxResults(1)
            ;
        return $qb->getQuery()->getSingleResult() ;   
    }

    /**
    *   Retourne toutes les équipes d'une école d'une édition
    */
    public function findAllTeamsBySchool($idSchool,$editionId)
    {
        $qb = $this -> createQueryBuilder('t')
                    -> join('t.users','u')
                    -> addSelect('u')
                    -> join('u.school','s')
                    -> where('s.id = :idSchool')
                     -> setParameter('idSchool', $idSchool)
                    -> join('s.editions','e')
                    -> andWhere('e.id = :editionId')
                     -> setParameter('editionId',$editionId)
                     ;

        return $qb->getQuery()->getResult() ;
    }

    public function findAllTeamsByEditionByUsers($userIdArray,$editionId)
    {
        $qb = $this -> createQueryBuilder('t')
            -> join('t.users','u')
            ->addSelect('u')
            -> where('u.id IN (:userIdArray)')
             -> setParameter('userIdArray', $userIdArray)
            -> join('t.edition','e')
            -> andWhere('e.id = :editionId')
             ->setParameter('editionId', $editionId)
            ->distinct()
            ;

        return $qb->getQuery()->getResult() ; 
    }

}
